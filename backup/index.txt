<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¸ì—¬ìœ¨ ê´€ë¦¬</title>
    <style>
        #totalParticipation {
            font-size: 16px;
            font-weight: bold;
        }
        .overLimit {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ì°¸ì—¬ìœ¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>

    <div style="display: flex;">
        <div style="width: 50%; padding: 10px; border-right: 1px solid #000;">
            <h2>ì¸ì› ê´€ë¦¬</h2>
            <label for="departmentSelect">ë¶€ì„œ ì„ íƒ:</label>
            <select id="departmentSelect" onchange="loadStaff()">
                <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>

            <h3>ì§ì› ëª©ë¡</h3>
            <select id="staffSelect">
                <option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>

            <h3>ì‚¬ì—… ì„ íƒ</h3>
            <p id="totalParticipation">ì´ ì°¸ì—¬ìœ¨: 0%</p>
            <div id="projectInputs"></div>
            <button onclick="addProjectInput()">ì‚¬ì—… ì¶”ê°€</button>
            <button onclick="saveAllParticipation()">ì €ì¥</button>
        </div>

        <div style="width: 50%; padding: 10px;">
            <h2>ì‚¬ì—… ê´€ë¦¬</h2>
            <label for="projectDepartmentSelect">ë¶€ì„œ ì„ íƒ:</label>
            <select id="projectDepartmentSelect" onchange="loadProjects()">
                <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>

            <h3>ì‚¬ì—… ëª©ë¡</h3>
            <ul id="projectList"></ul>
        </div>
    </div>

    <!-- âœ… JS ì½”ë“œê°€ ì‹¤í–‰ë˜ê¸° ì „ì— ì •ì˜ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ í•´ê²° -->
    <script>
        let projectCount = 0;

        function loadDepartments() {
        fetch("http://127.0.0.1:8000/departments")
            .then(response => response.json())
            .then(data => {
                console.log("DEBUG: ë°›ì•„ì˜¨ ë¶€ì„œ ëª©ë¡ =>", data); // ğŸš€ ë””ë²„ê¹…ìš© ì½˜ì†” ë¡œê·¸ ì¶”ê°€

                if (!Array.isArray(data.departments)) { // ğŸ›  dataê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                    console.error("ë¶€ì„œ ëª©ë¡ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", data);
                    return;
                }

                const departmentSelect = document.getElementById("departmentSelect");
                const projectDepartmentSelect = document.getElementById("projectDepartmentSelect");

                departmentSelect.innerHTML = `<option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>`;
                projectDepartmentSelect.innerHTML = `<option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>`;

                data.departments.forEach(dept => { // âœ… ìˆ˜ì •ëœ API êµ¬ì¡° ë°˜ì˜
                    let option1 = document.createElement("option");
                    option1.value = dept;
                    option1.textContent = dept;
                    departmentSelect.appendChild(option1);

                    let option2 = document.createElement("option");
                    option2.value = dept;
                    option2.textContent = dept;
                    projectDepartmentSelect.appendChild(option2);
                });
            })
            .catch(error => console.error("ë¶€ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
    }
    function loadStaff() {
        const department = document.getElementById("departmentSelect").value;
        if (!department) return;

        fetch(`http://127.0.0.1:8000/staff?department=${department}`)
            .then(response => response.json())
            .then(data => {
                console.log("DEBUG: ë°›ì•„ì˜¨ ì§ì› ëª©ë¡ =>", data);  // ğŸš€ ë””ë²„ê¹…ìš© ì½˜ì†” ë¡œê·¸ ì¶”ê°€
                const staffSelect = document.getElementById("staffSelect");
                staffSelect.innerHTML = `<option value="">ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>`;

                data.forEach(staff => {
                    let option = document.createElement("option");
                    option.value = staff.staffId;
                    option.textContent = `${staff.userName} (${staff.staffId})`;
                    staffSelect.appendChild(option);
                });
            })
            .catch(error => console.error("ì§ì› ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
    }

        function addProjectInput() {
            if (projectCount >= 5) {
                alert("ìµœëŒ€ 5ê°œì˜ ì‚¬ì—…ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
                return;
            }

            projectCount++;
            const projectInputs = document.getElementById("projectInputs");
            const div = document.createElement("div");
            div.innerHTML = `
                <span>ìˆœë²ˆ ${projectCount}:</span>
                <input type="text" class="selectedProject" readonly placeholder="ì˜¤ë¥¸ìª½ì—ì„œ ì‚¬ì—… ì„ íƒ">
                <input type="number" class="participationRate" placeholder="ì°¸ì—¬ìœ¨ ì…ë ¥ (%)" oninput="updateTotalParticipation()">
                <button onclick="removeProjectInput(this)">ì‚­ì œ</button>
            `;
            projectInputs.appendChild(div);
        }

        function removeProjectInput(button) {
            button.parentElement.remove();
            projectCount--;
            updateTotalParticipation();
        }

        function loadProjects() {
            const department = document.getElementById("projectDepartmentSelect").value;
            if (!department) return;

            fetch(`http://127.0.0.1:8000/projects?department=${department}`)
                .then(response => response.json())
                .then(data => {
                    console.log("DEBUG: ë°›ì•„ì˜¨ ì‚¬ì—… ëª©ë¡ ->", data);
                    const projectList = document.getElementById("projectList");
                    projectList.innerHTML = "";
                    data.forEach(project => {
                        let li = document.createElement("li");
                        li.textContent = project.projectName;
                        li.onclick = () => selectProject(project.projectId, project.projectName);
                        projectList.appendChild(li);
                    });
                })
                .catch(error => console.error("ì‚¬ì—… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
        }

        function selectProject(projectId, projectName) {
            const projectInputs = document.querySelectorAll(".selectedProject");
            for (let input of projectInputs) {
                if (!input.value) {
                    input.value = projectName;
                    input.dataset.projectId = projectId;
                    return;
                }
            }
            alert("ì‚¬ì—… ì…ë ¥ë€ì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”!");
        }

        function updateTotalParticipation() {
            let total = 0;
            document.querySelectorAll(".participationRate").forEach(input => {
                total += parseFloat(input.value) || 0;
            });

            const totalDisplay = document.getElementById("totalParticipation");
            totalDisplay.textContent = `ì´ ì°¸ì—¬ìœ¨: ${total}%`;

            if (total > 100) {
                totalDisplay.classList.add("overLimit");
            } else {
                totalDisplay.classList.remove("overLimit");
            }
        }

        function saveAllParticipation() {
            const staffId = document.getElementById("staffSelect").value;
            if (!staffId) {
                alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!");
                return;
            }

            let participationData = [];
            document.querySelectorAll("#projectInputs div").forEach(div => {
                const projectName = div.querySelector(".selectedProject").value;
                const participationRate = parseFloat(div.querySelector(".participationRate").value) || 0;

                if (!projectName) {
                    alert("ì‚¬ì—…ì„ ì„ íƒí•˜ì„¸ìš”!");
                    return;
                }

                participationData.push({
                    staffId: staffId,
                    projectName: projectName,
                    participationRate: participationRate
                });
            });

            if (participationData.length === 0) {
                alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }

            fetch("http://127.0.0.1:8000/participation", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(participationData)
            })
            .then(response => response.json())
            .then(data => alert(data.message))
            .catch(error => console.error("ì°¸ì—¬ìœ¨ ì €ì¥ ì‹¤íŒ¨:", error));
        }

        // âœ… í˜ì´ì§€ ë¡œë”© ì‹œ ë¶€ì„œ ëª©ë¡ ìë™ ë¡œë“œ (ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ëœ í›„ í˜¸ì¶œë¨)
        window.onload = function() {
            loadDepartments();
        };
    </script>
</body>
</html>
