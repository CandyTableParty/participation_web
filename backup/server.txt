from fastapi import FastAPI, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import pymysql
from typing import List

app = FastAPI()

# CORS ì„¤ì • ì¶”ê°€
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

def get_db_connection():
    return pymysql.connect(
        host="localhost",
        user="root",
        password="jun1206",
        database="jun",
        cursorclass=pymysql.cursors.DictCursor
    )

# âœ… ë¶€ì„œ ëª©ë¡ ì¡°íšŒ API (ì¸ì› ê´€ë¦¬ & ì‚¬ì—… ê´€ë¦¬ ë¶„ë¦¬)
@app.get("/departments")
def get_departments():
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("SELECT DISTINCT staffDepartment FROM staff")
        departments = cursor.fetchall()
        
        # ğŸ›  departmentsê°€ [{staffDepartment: "ë””ì§€í„¸í˜ì‹ ë‹¨"}] ì´ëŸ° í˜•íƒœë¡œ ë°˜í™˜ë˜ëŠ” ê²½ìš°ê°€ ìˆì–´ì„œ ìˆ˜ì •
        department_list = [dept["staffDepartment"] for dept in departments if dept["staffDepartment"]]
        
        return {"departments": department_list}  # âœ… JSON ê°ì²´ ëŒ€ì‹  ë°°ì—´ ë°˜í™˜

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

    finally:
        cursor.close()
        conn.close()
        
# âœ… ì§ì› ëª©ë¡ ì¡°íšŒ API
@app.get("/staff")
def get_staff(department: str = Query(None)):
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("SELECT staffId, userName FROM staff WHERE staffDepartment = %s", (department,))
        return cursor.fetchall()

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

    finally:
        cursor.close()
        conn.close()

# âœ… ì‚¬ì—… ëª©ë¡ ì¡°íšŒ API
@app.get("/projects")
def get_projects(department: str = Query(None)):
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("SELECT projectId, projectName FROM projects WHERE department = %s", (department,))
        return cursor.fetchall()

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

    finally:
        cursor.close()
        conn.close()

# âœ… ì°¸ì—¬ìœ¨ ì…ë ¥ì„ ìœ„í•œ ë°ì´í„° ëª¨ë¸
class ParticipationInput(BaseModel):
    staffId: str
    projectId: str
    participationRate: float

# âœ… ì°¸ì—¬ìœ¨ ì €ì¥ API
@app.post("/participation")
def save_participation(data: List[ParticipationInput]):
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        for entry in data:
            cursor.execute("""
                INSERT INTO participation (staffId, projectId, participationRate1) 
                VALUES (%s, %s, %s) 
                ON DUPLICATE KEY UPDATE participationRate1 = %s
            """, (entry.staffId, entry.projectId, entry.participationRate, entry.participationRate))
        
        conn.commit()
        return {"message": "ì°¸ì—¬ìœ¨ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"}

    except Exception as e:
        conn.rollback()
        raise HTTPException(status_code=500, detail=f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

    finally:
        cursor.close()
        conn.close()

# âœ… FastAPI ì‹¤í–‰ ì½”ë“œ ì¶”ê°€ (ì¤‘ìš”)
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="127.0.0.1", port=8000)
